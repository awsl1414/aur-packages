name: Update AUR Packages
on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    defaults:
      run:
        # 默认工作目录设为仓库根（用于构建步骤）
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 安装必要工具
      - name: Setup system packages
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git openssh sudo curl

      # 使用官方 action 安装 uv + Python 3.13（自动添加 PATH，无需手动 export）
      - name: Setup uv & Python 3.13
        uses: astral-sh/setup-uv@v7
        with:
          python-version: '3.13'
          enable-cache: true  # 启用 uv 缓存，加速依赖安装

      # 使用 uv 安装 Python 依赖（切换到 scripts 目录）
      - name: Setup Python dependencies
        working-directory: scripts  # 关键修复：指定项目目录
        run: |
          if [ -f "pyproject.toml" ]; then
            echo "Found pyproject.toml, syncing dependencies..."
            ls -la  # 调试：列出 scripts 目录文件
            uv sync
          else
            echo "Error: pyproject.toml not found in scripts/!"
            echo "Available files in scripts/:"
            ls -la
            echo "This workflow requires pyproject.toml in scripts/ for Python dependency management."
            exit 1
          fi

      # 运行更新脚本（也在 scripts 目录，确保 main.py 正确执行）
      - name: Run main update script
        working-directory: scripts  # 关键修复：统一目录
        run: |
          uv run main.py

      # 创建非 root 构建用户
      - name: Create build user
        run: |
          useradd -m builduser
          echo "builduser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/builduser
          passwd -d builduser

      # SSH 配置用于 push AUR
      - name: Setup SSH for AUR
        run: |
          sudo -u builduser mkdir -p /home/builduser/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" | sudo -u builduser tee /home/builduser/.ssh/id_ed25519 >/dev/null
          sudo -u builduser chmod 600 /home/builduser/.ssh/id_ed25519
          sudo -u builduser ssh-keyscan aur.archlinux.org >> /home/builduser/.ssh/known_hosts

      # builduser 构建目录权限
      - name: Configure makepkg for builduser
        run: |
          cp /etc/makepkg.conf /home/builduser/makepkg.conf
          sed -i 's|^#*\s*BUILDDIR=.*|BUILDDIR=/home/builduser/build|' /home/builduser/makepkg.conf
          sed -i 's|^#*\s*PKGDEST=.*|PKGDEST=/home/builduser/pkgdest|' /home/builduser/makepkg.conf
          sed -i 's|^#*\s*SRCDEST=.*|SRCDEST=/home/builduser/srcdest|' /home/builduser/makepkg.conf
          mkdir -p /home/builduser/build /home/builduser/pkgdest /home/builduser/srcdest
          chown -R builduser:builduser /home/builduser

      # 构建 + 推送所有包（在根目录循环 packages/*，main.py 更新后这里构建）
      - name: Build & Push AUR packages
        run: |
          set -e
          export MAKEPKG_CONF=/home/builduser/makepkg.conf
          for pkg in packages/*; do
            if [ -f "$pkg/PKGBUILD" ]; then
              echo "=== Processing: $pkg ==="
              pkgname=$(basename "$pkg")
              aur_repo="ssh://aur@aur.archlinux.org/${pkgname}.git"
              cd "$pkg"
              echo "生成 .SRCINFO..."
              sudo -u builduser MAKEPKG_CONF=$MAKEPKG_CONF makepkg --printsrcinfo > .SRCINFO
              echo "构建测试 $pkgname ..."
              sudo -u builduser MAKEPKG_CONF=$MAKEPKG_CONF makepkg -fs --noconfirm
              cd ../../
              # 克隆 AUR 仓库
              sudo -u builduser git clone "$aur_repo" "/home/builduser/aur-$pkgname"
              # 复制所有文件（包含隐藏文件）
              sudo -u builduser cp -a "$pkg"/. "/home/builduser/aur-$pkgname/"
              cd "/home/builduser/aur-$pkgname"
              sudo -u builduser git config user.email "github-actions@github.com"
              sudo -u builduser git config user.name "GitHub Actions"
              sudo -u builduser git add -A
              sudo -u builduser git commit -m "Update: $(date -u +"%Y-%m-%d")" || echo "No changes"
              sudo -u builduser git push || echo "Nothing to push"
              cd -
            fi
          done